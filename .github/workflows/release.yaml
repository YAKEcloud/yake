name: Releases

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3.1.0
      - name: Upload to release bucket
        env:
          MINIO_HOSTNAME: ${{ secrets.MINIOHOSTNAME }}
          MINIO_URL: ${{ secrets.MINIOURL }}
          MINIO_PW: ${{ secrets.MINIOPASSWORD }}
        run: |
          export MC_ALIAS=releases
          export MC_HOST_$MC_ALIAS=https://minio:$MINIO_PW@$MINIO_HOSTNAME

          releaseName=$(git describe --tags)
          mc mb $MC_ALIAS/$releaseName

          mc cp kustomization.yaml $MC_ALIAS/$releaseName
          mc cp --recursive flux-system $MC_ALIAS/$releaseName
          mc cp --recursive flux $MC_ALIAS/$releaseName
          mc cp --recursive base-addons $MC_ALIAS/$releaseName
          mc cp --recursive pre-gardener $MC_ALIAS/$releaseName
          mc cp --recursive gardener $MC_ALIAS/$releaseName

          for file in $(grep --exclude-dir=hack --exclude-dir=flux-system -lr GitRepository . | sed 's/^\.\///'); do
            cat $file | sed s/GitRepository/Bucket/ | mc pipe $MC_ALIAS/$releaseName/$file
          done
