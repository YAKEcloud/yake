"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[1510],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>u});var a=r(67294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var l=a.createContext({}),h=function(e){var t=a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},c=function(e){var t=h(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=h(r),m=n,u=d["".concat(l,".").concat(m)]||d[m]||p[m]||o;return r?a.createElement(u,i(i({ref:t},c),{},{components:r})):a.createElement(u,i({ref:t},c))}));function u(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:n,i[1]=s;for(var h=2;h<o;h++)i[h]=r[h];return a.createElement.apply(null,i)}return a.createElement.apply(null,r)}m.displayName="MDXCreateElement"},57112:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>h});var a=r(87462),n=(r(67294),r(3905));const o={slug:"gardener-chart-releaser",title:"A Single Point of Truth for Gardener Helm Charts",authors:["jensac","mxmxchere"],tags:["gardener","gardener-community"]},i=void 0,s={permalink:"/blog/gardener-chart-releaser",editUrl:"https://github.com/23technologies/23ke-docs/tree/main/blog/2022-09-19-gardener-chart-releaser.md",source:"@site/blog/2022-09-19-gardener-chart-releaser.md",title:"A Single Point of Truth for Gardener Helm Charts",description:"TLDR;",date:"2022-09-19T00:00:00.000Z",formattedDate:"September 19, 2022",tags:[{label:"gardener",permalink:"/blog/tags/gardener"},{label:"gardener-community",permalink:"/blog/tags/gardener-community"}],readingTime:5.08,hasTruncateMarker:!1,authors:[{name:"Jens Schneider",title:"software engineer",url:"https://github.com/jensac",imageURL:"https://github.com/jensac.png",key:"jensac"},{name:"Malte M\xfcnch",url:"https://github.com/mxmxchere",imageURL:"https://github.com/mxmxchere.png",key:"mxmxchere"}],frontMatter:{slug:"gardener-chart-releaser",title:"A Single Point of Truth for Gardener Helm Charts",authors:["jensac","mxmxchere"],tags:["gardener","gardener-community"]},prevItem:{title:"Hack-The-Garden - the Remote Hackathon Experience",permalink:"/blog/hack-the-garden"},nextItem:{title:"Getting started with Gardener extension development",permalink:"/blog/gardener-ext-dev"}},l={authorsImageUrls:[void 0,void 0]},h=[{value:"TLDR;",id:"tldr",level:2},{value:"Introduction",id:"introduction",level:2},{value:"The Gardener Chart Releaser",id:"the-gardener-chart-releaser",level:2},{value:"Export the charts to a local directory",id:"export-the-charts-to-a-local-directory",level:3},{value:"Update all version field to the latest version",id:"update-all-version-field-to-the-latest-version",level:3},{value:"Handling Gardener extensions",id:"handling-gardener-extensions",level:2},{value:"Running the release process nightly",id:"running-the-release-process-nightly",level:2},{value:"Summary",id:"summary",level:2}],c={toc:h};function d(e){let{components:t,...r}=e;return(0,n.kt)("wrapper",(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h2",{id:"tldr"},"TLDR;"),(0,n.kt)("p",null,"Recently, we consolidated Gardener related Helm charts in a helm repository hosted on GitHub pages of the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/gardener-community/gardener-charts"},"gardener-charts")," repository.\nFor this purpose we implemented a custom chart release bot - the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/gardener-community/gardener-chart-releaser"},"gardener-chart-releaser"),".\nKeep on reading to find out more."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Table of Contents")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#tldr"},"TLDR;")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#introduction"},"Introduction")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#the-gardener-chart-releaser"},"The Gardener Chart Releaser"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#export-the-charts-to-a-local-directory"},"Export the charts to a local directory")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#update-all-version-field-to-the-latest-version"},"Update all version field to the latest version")))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#handling-gardener-extensions"},"Handling Gardener extensions")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#running-the-release-process-nightly"},"Running the release process nightly")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#summary"},"Summary"))),(0,n.kt)("h2",{id:"introduction"},"Introduction"),(0,n.kt)("p",null,"Installing ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/gardener/gardener"},"Gardener")," is a complicated process, even though the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/gardener/garden-setup"},"garden-setup")," installer is provided in the same GitHub organization space. One of the reasons is that the Gardener related Helm charts are spread over multiple repositories.\nConsequently, other Helm chart-based installers like ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/schrodit/gardener-installation"},"Schrodit's")," ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/schrodit/gardener-installation"},"gardener-installation")," popped up.\nMoreover, we consolidated gardener related Helm charts in the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/23technologies/23ke-charts"},"23ke-charts")," repository by a simple Python script, and developed a very ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/23technologies/23ke-charts/tree/main/hack/gardener-from-helmcharts"},"basic installation approach")," based on these charts.\nThe chart collection was released in a Helm repository hosted on GitHub pages by helm's ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/helm/chart-releaser"},"chart-releaser"),".\nWith the consolidation of the Gardener charts, we faced the issue that the collected charts need to be kept up to date somehow.\nThere our journey begins, and we started to keep track of the upstream charts with the help of ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/renovatebot/renovate"},"renovate"),".\nHowever, renovate is designed to keep dependencies up to date and finds its limitations, when it comes to tracking multiple versions of the same piece of software.\nFirst, we tried to find a workaround by tracking three branches for the last three minor versions and shifted the latest branch, as soon as a new minor release appeared.\nEven though this approach could potentially succeed, we were running into issues from time to time due to missing automatic merges, or failures in the branch shift routine.\nAs a consequence, we decided to build our own tracking tool, the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/gardener-community/gardener-chart-releaser"},"gardener-chart-releaser"),"."),(0,n.kt)("h2",{id:"the-gardener-chart-releaser"},"The Gardener Chart Releaser"),(0,n.kt)("p",null,"As already stated above, we wanted to keep track of the last three minor versions of all Gardener related Helm charts, and release these charts in a single helm repository.\nIn order to achieve this, we needed to make some decisions.\nFirst, we needed to drop our old Python-based Helm chart import script, as working with helm charts in code is way easier, when using the Go-based ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/helm/helm/tree/main/pkg"},"helm packages")," directly. Further, helm's ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/helm/chart-releaser"},"chart-releaser")," is written in Go and there exists a solid implementation of a git and GitHub module in Go.\nSo, we reimplemented our chart import and release functionality in Go with a view to tracking the last three minor releases.\nAnother design goal was to keep the tool simple, especially from the user point of view.\nAs of now, the user only needs to worry about a configuration file in yaml format.\nConsider the following example:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"# contents of config.yaml\ndestination:\n    owner: gardener-community\n    repo: gardener-charts\nsources:\n    - name: gardener-controlplane\n      version: v1.53.0\n      repo: gardener/gardener\n      charts:\n        - charts/gardener/controlplane\n  - ...\n")),(0,n.kt)("p",null,"The ",(0,n.kt)("inlineCode",{parentName:"p"},"destination")," map defines a GitHub owner and repository, where the collected charts are released.\nUnder ",(0,n.kt)("inlineCode",{parentName:"p"},"sources")," a list of source Helm charts is provided by an ",(0,n.kt)("inlineCode",{parentName:"p"},"owner/repo")," entry and a list of paths pointing to the charts to be released.\nWith a valid ",(0,n.kt)("inlineCode",{parentName:"p"},"config.yaml")," a user can simply run"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"export GITHUB_TOKEN=....\ngardener-chart-releaser update\n")),(0,n.kt)("p",null,"and the configured charts will be collected and released.\nNote that the ",(0,n.kt)("inlineCode",{parentName:"p"},"version")," field is ignored for the actual release process, as we want to track several versions.\nHowever, the ",(0,n.kt)("inlineCode",{parentName:"p"},"version")," field has its own reasoning. Keep on reading ;-)"),(0,n.kt)("h3",{id:"export-the-charts-to-a-local-directory"},"Export the charts to a local directory"),(0,n.kt)("p",null,"Just by collecting and releasing charts to a GitHub repository you won't get to see the charts' contents at all.\nBut what if you want to work with the charts itself in a local development scenario.\nFor this purpose, you can export the charts to a local directory instead of releasing them to a remote repo.\nJust call"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"gardener-chart-releaser export\n")),(0,n.kt)("p",null,"and the charts will be exported to a local ",(0,n.kt)("inlineCode",{parentName:"p"},"./charts")," directory.\nIn this case, the ",(0,n.kt)("inlineCode",{parentName:"p"},"version")," field in ",(0,n.kt)("inlineCode",{parentName:"p"},"config.yaml")," defines the version to be exported."),(0,n.kt)("h3",{id:"update-all-version-field-to-the-latest-version"},"Update all version field to the latest version"),(0,n.kt)("p",null,"As the entire Gardener ecosystem is moving quickly, your ",(0,n.kt)("inlineCode",{parentName:"p"},"config.yaml")," will be outdated soon.\nIn order to avoid manual updates of the ",(0,n.kt)("inlineCode",{parentName:"p"},"version")," fields, we introduced another command called ",(0,n.kt)("inlineCode",{parentName:"p"},"fetchLatestVersions"),".\nIf you run"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"gardener-chart-releaser fetchLatestVersions\n")),(0,n.kt)("p",null,"your ",(0,n.kt)("inlineCode",{parentName:"p"},"config.yaml")," will be updated, so that you will find the versions of the latest upstream releases in the file.\nOf course, it only makes sense to run this before a local export to make sure that the most recent versions of charts are exported."),(0,n.kt)("h2",{id:"handling-gardener-extensions"},"Handling Gardener extensions"),(0,n.kt)("p",null,"You might be wondering how Gardener extensions are managed in this approach, as these are not provided as Helm charts upstream.\nRemember that we wanted to build a single point of truth for a Gardener provisioning, and consequently the gardener-chart-releaser also packages Gardener extensions as charts.\nFor each entry like e.g."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"sources:\n  - name: runtime-gvisor\n    version: v0.5.1\n    repo: gardener/gardener-extension-runtime-gvisor\n    charts:\n      - controller-registration\n")),(0,n.kt)("p",null,"in the configuration file, it will generate a Helm chart for the specified extension and release it the same way as the Gardener core charts.\nFurthermore, this approach provides the opportunity to release charts for the extension itself (i.e. controllerRegistration and controllerDeployment) and the charts for the admission controllers as sub-charts.\nFor instance"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"sources:\n  - name: provider-azure\n    version: v1.29.0\n    repo: gardener/gardener-extension-provider-azure\n    charts:\n      - controller-registration\n      - charts/gardener-extension-admission-azure\n")),(0,n.kt)("p",null,"will package a top-level chart called ",(0,n.kt)("inlineCode",{parentName:"p"},"provider-azure")," with sub-charts for the extension controller and admission controller, respectively."),(0,n.kt)("h2",{id:"running-the-release-process-nightly"},"Running the release process nightly"),(0,n.kt)("p",null,"As we want to be as transparent as possible, we set up a GitHub ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/gardener-community/gardener-charts/actions"},"action"),", so that the chart-releaser is run nightly.\nThis will ensure that we do not miss any important upstream change and the Helm repository is always up to date."),(0,n.kt)("h2",{id:"summary"},"Summary"),(0,n.kt)("p",null,"The gardener-chart-releaser enables a single point of truth for Gardener related Helm charts and could be a good starting point for custom Gardener installation routines."))}d.isMDXComponent=!0}}]);