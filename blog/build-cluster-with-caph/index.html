<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Build Cluster with CAPH - the challanges when installing 23KE | Yet another Kubernetes Engine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yake.cloud/blog/build-cluster-with-caph"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="gardener" content="installation, production, operations, maintenance"><meta data-rh="true" property="og:title" content="Build Cluster with CAPH - the challanges when installing 23KE | Yet another Kubernetes Engine"><meta data-rh="true" name="description" content="TLDR;"><meta data-rh="true" property="og:description" content="TLDR;"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-05-12T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/rhizoet"><meta data-rh="true" property="article:tag" content="gardener,caph,k8s"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yake.cloud/blog/build-cluster-with-caph"><link data-rh="true" rel="alternate" href="https://yake.cloud/blog/build-cluster-with-caph" hreflang="en"><link data-rh="true" rel="alternate" href="https://yake.cloud/blog/build-cluster-with-caph" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://yake.cloud/blog/build-cluster-with-caph","mainEntityOfPage":"https://yake.cloud/blog/build-cluster-with-caph","url":"https://yake.cloud/blog/build-cluster-with-caph","headline":"Build Cluster with CAPH - the challanges when installing 23KE","name":"Build Cluster with CAPH - the challanges when installing 23KE","description":"TLDR;","datePublished":"2023-05-12T00:00:00.000Z","author":{"@type":"Person","name":"Marius Wernicke","description":"DevOps Engineer","url":"https://github.com/rhizoet","image":"https://github.com/rhizoet.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://yake.cloud/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Yet another Kubernetes Engine RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Yet another Kubernetes Engine Atom Feed"><link rel="stylesheet" href="/assets/css/styles.cf7d8bb1.css">
<script src="/assets/js/runtime~main.67924c46.js" defer="defer"></script>
<script src="/assets/js/main.89dc9751.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="/img/logo_dark.svg"><link rel="preload" as="image" href="https://github.com/rhizoet.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="YAKE" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo_dark.svg" alt="YAKE" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">YAKE</b></a><a class="navbar__item navbar__link" href="/docs/overview">Docs</a><a class="navbar__item navbar__link" href="/release-notes/v1.133">Release Notes</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/overview">1.133.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/overview">Next</a></li><li><a class="dropdown__link" href="/docs/overview">1.133.x</a></li><li><a class="dropdown__link" href="/docs/1.132.x/overview">1.132.x</a></li><li><a class="dropdown__link" href="/docs/1.131.x/overview">1.131.x</a></li><li><a class="dropdown__link" href="/docs/1.128.x/overview">1.128.x</a></li><li><a class="dropdown__link" href="/docs/1.127.x/overview">1.127.x</a></li><li><a class="dropdown__link" href="/docs/1.126.x/overview">1.126.x</a></li><li><a class="dropdown__link" href="/docs/1.125.x/overview">1.125.x</a></li><li><a class="dropdown__link" href="/docs/1.124.x/overview">1.124.x</a></li><li><a class="dropdown__link" href="/docs/1.123.x/overview">1.123.x</a></li><li><a class="dropdown__link" href="/docs/1.122.x/overview">1.122.x</a></li><li><a class="dropdown__link" href="/docs/1.121.x/overview">1.121.x</a></li><li><a class="dropdown__link" href="/docs/1.120.x/overview">1.120.x</a></li><li><a class="dropdown__link" href="/docs/1.119.x/overview">1.119.x</a></li><li><a class="dropdown__link" href="/docs/1.118.x/overview">1.118.x</a></li><li><a class="dropdown__link" href="/docs/1.117.x/overview">1.117.x</a></li><li><a class="dropdown__link" href="/docs/1.116.x/overview">1.116.x</a></li><li><a class="dropdown__link" href="/docs/1.115.x/overview">1.115.x</a></li><li><a class="dropdown__link" href="/docs/1.114.x/overview">1.114.x</a></li><li><a class="dropdown__link" href="/docs/1.113.x/overview">1.113.x</a></li><li><a class="dropdown__link" href="/docs/1.112.x/overview">1.112.x</a></li><li><a class="dropdown__link" href="/docs/1.111.x/overview">1.111.x</a></li><li><a class="dropdown__link" href="/docs/1.110.x/overview">1.110.x</a></li><li><a class="dropdown__link" href="/docs/1.109.x/overview">1.109.x</a></li><li><a class="dropdown__link" href="/docs/1.108.x/overview">1.108.x</a></li><li><a class="dropdown__link" href="/docs/1.107.x/overview">1.107.x</a></li><li><a class="dropdown__link" href="/docs/1.106.x/overview">1.106.x</a></li><li><a class="dropdown__link" href="/docs/1.105.x/overview">1.105.x</a></li><li><a class="dropdown__link" href="/docs/1.104.x/overview">1.104.x</a></li><li><a class="dropdown__link" href="/docs/1.103.x/overview">1.103.x</a></li><li><a class="dropdown__link" href="/docs/1.102.x/overview">1.102.x</a></li><li><a class="dropdown__link" href="/docs/1.101.x/overview">1.101.x</a></li><li><a class="dropdown__link" href="/docs/1.100.x/overview">1.100.x</a></li><li><a class="dropdown__link" href="/docs/1.99.x/overview">1.99.x</a></li><li><a class="dropdown__link" href="/docs/1.98.x/overview">1.98.x</a></li><li><a class="dropdown__link" href="/docs/1.97.x/overview">1.97.x</a></li><li><a class="dropdown__link" href="/docs/1.96.x/overview">1.96.x</a></li><li><a class="dropdown__link" href="/docs/1.95.x/overview">1.95.x</a></li><li><a class="dropdown__link" href="/docs/1.94.x/overview">1.94.x</a></li><li><a class="dropdown__link" href="/docs/1.93.x/overview">1.93.x</a></li><li><a class="dropdown__link" href="/docs/1.92.x/overview">1.92.x</a></li><li><a class="dropdown__link" href="/docs/1.91.x/overview">1.91.x</a></li><li><a class="dropdown__link" href="/docs/1.90.x/overview">1.90.x</a></li><li><a class="dropdown__link" href="/docs/1.89.x/overview">1.89.x</a></li><li><a class="dropdown__link" href="/docs/1.88.x/overview">1.88.x</a></li><li><a class="dropdown__link" href="/docs/1.87.x/overview">1.87.x</a></li><li><a class="dropdown__link" href="/docs/1.86.x/overview">1.86.x</a></li><li><a class="dropdown__link" href="/docs/1.85.x/overview">1.85.x</a></li><li><a class="dropdown__link" href="/docs/1.84.x/overview">1.84.x</a></li><li><a class="dropdown__link" href="/docs/1.83.x/overview">1.83.x</a></li><li><a class="dropdown__link" href="/docs/1.82.x/overview">1.82.x</a></li><li><a class="dropdown__link" href="/docs/1.81.x/overview">1.81.x</a></li><li><a class="dropdown__link" href="/docs/1.80.x/overview">1.80.x</a></li><li><a class="dropdown__link" href="/docs/1.79.x/overview">1.79.x</a></li><li><a class="dropdown__link" href="/docs/1.78.x/overview">1.78.x</a></li><li><a class="dropdown__link" href="/docs/1.77.x/overview">1.77.x</a></li><li><a class="dropdown__link" href="/docs/1.76.x/overview">1.76.x</a></li><li><a class="dropdown__link" href="/docs/1.75.x/overview">1.75.x</a></li><li><a class="dropdown__link" href="/docs/1.74.x/overview">1.74.x</a></li><li><a class="dropdown__link" href="/docs/1.73.x/overview">1.73.x</a></li><li><a class="dropdown__link" href="/docs/1.72.x/overview">1.72.x</a></li><li><a class="dropdown__link" href="/docs/1.71.x/overview">1.71.x</a></li><li><a class="dropdown__link" href="/docs/1.70.x/overview">1.70.x</a></li><li><a class="dropdown__link" href="/docs/1.69.x/overview">1.69.x</a></li><li><a class="dropdown__link" href="/docs/1.68.x/overview">1.68.x</a></li><li><a class="dropdown__link" href="/docs/1.67.x/overview">1.67.x</a></li><li><a class="dropdown__link" href="/docs/1.66.x/overview">1.66.x</a></li><li><a class="dropdown__link" href="/docs/1.65.x/overview">1.65.x</a></li><li><a class="dropdown__link" href="/docs/1.64.x/overview">1.64.x</a></li><li><a class="dropdown__link" href="/docs/1.63.x/overview">1.63.x</a></li></ul></div><a href="https://github.com/yakecloud/yake" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Gardener Hackathon 2023">Gardener Hackathon - May 2023</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/build-cluster-with-caph">Build Cluster with CAPH - the challanges when installing 23KE</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hack-the-garden">Hack-The-Garden - the Remote Hackathon Experience</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/gardener-chart-releaser">A Single Point of Truth for Gardener Helm Charts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/gardener-ext-dev">Getting started with Gardener extension development</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Build Cluster with CAPH - the challanges when installing 23KE</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-05-12T00:00:00.000Z">May 12, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/rhizoet" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/rhizoet.png" alt="Marius Wernicke"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/rhizoet" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp" translate="no">Marius Wernicke</span></a></div><small class="authorTitle_nd0D" title="DevOps Engineer">DevOps Engineer</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="tldr">TLDR;<a href="#tldr" class="hash-link" aria-label="Direct link to TLDR;" title="Direct link to TLDR;" translate="no">​</a></h2>
<p>We recently built new Kubernetes clusters on Hetzner Cloud. We had several challenges to get the cluster up and running.</p>
<p>This started with the selection of the correct Kubernetes version, the CNI solution and the actual deployment of 23KE. Spoiler: We had to change the CNI solution and reset containerd.</p>
<p>If these instructions in this blog post are followed, you can build a working Gardener cluster.</p>
<p><strong>Table of Contents</strong></p>
<ul>
<li class=""><a href="#tldr" class="">TLDR;</a></li>
<li class=""><a href="#introduction" class="">Introduction</a></li>
<li class=""><a href="#requirements" class="">Requirements</a></li>
<li class=""><a href="#setup-the-management-cluster" class="">Setup the management cluster</a>
<ul>
<li class=""><a href="#modifications" class="">Modifications</a></li>
</ul>
</li>
<li class=""><a href="#setup-the-worker-cluster" class="">Setup the worker cluster</a></li>
<li class=""><a href="#install-of-23ke" class="">Install of 23KE</a></li>
<li class=""><a href="#summary" class="">Summary</a></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" translate="no">​</a></h2>
<p>In times of rising costs and the reduction of the CO<sub>2</sub> footprint in all areas of life, we also wanted to reduce these sustainably in our day-to-day operations.</p>
<p>We had been running okeanos.dev on a managed kubernetes cluster on Azure. This is very expensive so we wanted to minimize these costs. In this case, the European cloud from Hetzner was the obvious choice. The following question was how we could best build a k8s cluster there.</p>
<p>After some research, ClusterAPI provider for Hetzner (CAPH) from <a href="https://syself.com/" target="_blank" rel="noopener noreferrer" class="">Syself</a> turned out to be the optimal solution.</p>
<p>When testing the provider, we had to overcome a few challenges, which we would like to discuss in the following.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="requirements">Requirements<a href="#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements" translate="no">​</a></h2>
<p>You need to install some basic tools to work with CAPH and Gardener. It makes sense to set up a management vm (on Hetzner) running a kind cluster and on it the management cluster.</p>
<ul>
<li class=""><a href="https://docs.docker.com/engine/install/" target="_blank" rel="noopener noreferrer" class="">docker-engine</a></li>
<li class=""><a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installing-from-release-binaries" target="_blank" rel="noopener noreferrer" class="">kind</a></li>
<li class=""><a href="https://cluster-api.sigs.k8s.io/user/quick-start.html#install-clusterctl" target="_blank" rel="noopener noreferrer" class="">clusterctl</a></li>
<li class=""><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/" target="_blank" rel="noopener noreferrer" class="">kubectl</a></li>
<li class=""><a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer" class="">helm</a></li>
<li class=""><a href="https://fluxcd.io/flux/installation/" target="_blank" rel="noopener noreferrer" class="">flux</a></li>
<li class=""><a href="https://k9scli.io/topics/install/" target="_blank" rel="noopener noreferrer" class="">k9s</a></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup-the-management-cluster">Setup the management cluster<a href="#setup-the-management-cluster" class="hash-link" aria-label="Direct link to Setup the management cluster" title="Direct link to Setup the management cluster" translate="no">​</a></h2>
<p>To start, let&#x27;s create a kind cluster with a customized Kubernetes version (Currently it is important that the kubernetes version is <code>&gt;1.26</code>)</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kind create cluster -n my-cluster --image=kindest/node:v1.25.9</span><br></span></code></pre></div></div>
<p>When the cluster is up, <a href="https://github.com/syself/cluster-api-provider-hetzner/blob/main/docs/topics/preparation.md" target="_blank" rel="noopener noreferrer" class="">initialize the management cluster</a> with CAPH</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">clusterctl init --core cluster-api --bootstrap kubeadm --control-plane kubeadm --infrastructure hetzner</span><br></span></code></pre></div></div>
<p>and export your environment variables</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export HCLOUD_SSH_KEY=&quot;MY_SSH_KEY&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CLUSTER_NAME=&quot;my-cluster&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HCLOUD_REGION=&quot;nbg1&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CONTROL_PLANE_MACHINE_COUNT=3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export WORKER_MACHINE_COUNT=3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export KUBERNETES_VERSION=1.25.9 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HCLOUD_CONTROL_PLANE_MACHINE_TYPE=cpx31 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HCLOUD_WORKER_MACHINE_TYPE=cpx41 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HCLOUD_TOKEN=&quot;YOUR_HCLOUD_TOKEN_HERE&quot;</span><br></span></code></pre></div></div>
<p>The region can be for sure anything else like <code>hel1</code>.</p>
<p>To be able to build the machines a secret must be created:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret generic hetzner --from-literal=hcloud=$HCLOUD_TOKEN</span><br></span></code></pre></div></div>
<p>You can also still build yourself a customized node image, but we didn&#x27;t do that. We used the Ubuntu 22.04 image, which is available from Hetzner.</p>
<p>Now let&#x27;s create the <code>my-cluster.yaml</code> with the private network flavor as in the <a href="https://github.com/syself/cluster-api-provider-hetzner/blob/main/docs/topics/quickstart.md" target="_blank" rel="noopener noreferrer" class="">quickstart-guide</a>:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">clusterctl generate cluster my-cluster --kubernetes-version v1.25.9 --control-plane-machine-count=3 --worker-machine-count=3 --flavor hcloud-network &gt; my-cluster.yaml</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="modifications">Modifications<a href="#modifications" class="hash-link" aria-label="Direct link to Modifications" title="Direct link to Modifications" translate="no">​</a></h3>
<p>After creation you need to modify the <code>my-cluster.yaml</code>. Remove the following blocks (it gives two of them) because we need to reset the containerd config</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- - content: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-     version = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-     [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-       runtime_type = &quot;io.containerd.runc.v2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-     [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-       SystemdCgroup = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-     [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.crun]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-       runtime_type = &quot;io.containerd.runc.v2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-     [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.crun.options]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-       BinaryName = &quot;crun&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-       Root = &quot;/usr/local/sbin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-       SystemdCgroup = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-     [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-       default_runtime_name = &quot;crun&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-     [plugins.&quot;io.containerd.runtime.v1.linux&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-       runtime = &quot;crun&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-       runtime_root = &quot;/usr/local/sbin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   owner: root:root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   path: /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   permissions: &quot;0744&quot;</span><br></span></code></pre></div></div>
<p>and add</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+ - mkdir /etc containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ - containerd config default &gt; /etc/containerd/confi.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ - sed -i &#x27;s/SystemdCgroup = false/SystemdCgroup = true/g&#x27; /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - systemctl daemon-reload &amp;&amp; systemctl enable containerd &amp;&amp; systemctl start containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ - sysctl fs.inotify.max_user_instances=8192</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ - sysctl fs.inotify.max_user_watches=524288</span><br></span></code></pre></div></div>
<p>The containerd-config is missing some options. In addition, the <code>SystemdCgroup</code> must be set to <code>true</code> and the <code>inotify</code> settings needs to be increased. Only then the <code>vpn-seed-server</code> starts, which is created when a shoot is created.</p>
<p>When you have finished the modification, you can start building the worker cluster by appling the modified file on the management cluster</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f my-cluster.yaml</span><br></span></code></pre></div></div>
<p>With <code>watch clusterctl describe cluster my-cluster</code> you can watch one control-plane and three workers are being built.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup-the-worker-cluster">Setup the worker cluster<a href="#setup-the-worker-cluster" class="hash-link" aria-label="Direct link to Setup the worker cluster" title="Direct link to Setup the worker cluster" translate="no">​</a></h2>
<blockquote>
<p><strong><em>NOTE:</em></strong> From now on you should make sure that you are working on the newly built cluster. Make sure that you have exported the Kubeconfig for the worker cluster!</p>
</blockquote>
<p>Get the kubeconfig of the worker cluster</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">clusterctl get kubeconfig my-cluster &gt; /path/to/my/worker-cluster.kc</span><br></span></code></pre></div></div>
<p>and export it to work on the cluster (you can do this on your local machine. You don&#x27;t need to work anymore on the management vm):</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export KUBECONFIG=/path/to/my/worker-cluster.kc</span><br></span></code></pre></div></div>
<p>At the point of &quot;Deploy a CNI solution&quot; keep in mind not to install cilium like in the guide but <a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/helm" target="_blank" rel="noopener noreferrer" class="">calico</a>. We had a lot of trouble with cilium.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add projectcalico https://docs.tigera.io/calico/charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace tigera-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install calico projectcalico/tigera-operator --version v3.25.1 --namespace tigera-operator</span><br></span></code></pre></div></div>
<p>Wait till calico is ready.</p>
<p>Now deploy the CCM for hcloud only. Set <code>privateNetwork.enabled=true</code> because we need a private network to function properly:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add syself https://charts.syself.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade --install ccm syself/ccm-hcloud --version 1.0.11 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --namespace kube-system \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set secret.name=hetzner \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set secret.tokenKeyName=hcloud \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set privateNetwork.enabled=true</span><br></span></code></pre></div></div>
<p>At the end we need a CSI to build volumes on hcloud:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt; EOF &gt; csi-values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storageClasses:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: hcloud-volumes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaultStorageClass: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reclaimPolicy: Retain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade --install csi syself/csi-hcloud --version 0.2.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --namespace kube-system -f csi-values.yaml</span><br></span></code></pre></div></div>
<p>The remaining control planes should now be built and added to the cluster. Wait until the entire cluster has <code>Ready</code> status before proceeding.</p>
<blockquote>
<p><strong><em>NOTE:</em></strong> If you want to transform the workload cluster into a management cluster, you need to do the &quot;move&quot;-steps in the guide. But its recommended to have a management vm with kind installed and hold there the management cluster.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="install-of-23ke">Install of 23KE<a href="#install-of-23ke" class="hash-link" aria-label="Direct link to Install of 23KE" title="Direct link to Install of 23KE" translate="no">​</a></h2>
<p>If you plan to install 23KE, you need to keep in mind that there are a few customizations that need to be made for hcloud.</p>
<p>If you have installed 23KE and the data from the installation is in a repository, the following file need to be adjusted.</p>
<p>Add the following lines in <code>gardenlet-values.yaml</code></p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">settings:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ loadBalancerServices:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+     load-balancer.hetzner.cloud/location: nbg1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+     load-balancer.hetzner.cloud/ipv6-disabled: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+     load-balancer.hetzner.cloud/disable-private-ingress: &quot;true&quot;</span><br></span></code></pre></div></div>
<p>Commit and push your changes. You can execute a <code>flux reconcile source git 23ke-config</code> to speed up the things.</p>
<p>If any ingress won&#x27;t get a public IP, you can add some annotations manualy e.g. for <code>nginx-ingress-controller</code>:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl annotate svc -n garden nginx-ingress-controller load-balancer.hetzner.cloud/location=nbg1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  load-balancer.hetzner.cloud/ipv6-disabled=true \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  load-balancer.hetzner.cloud/disable-private-ingress=true</span><br></span></code></pre></div></div>
<p>Now all things should come up as well as e.g. the dashboard should be accessible. If something is not running smoothly, the cluster can be inspected with k9s and you have an easy overview of what the problem is.</p>
<p>In the next steps, secrets can be added to connect to a public or private cloud. With these and a cloudprofile it is then possible to build and run shoots (k8s clusters).</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary" translate="no">​</a></h2>
<p>With all these steps, it is possible for you to build a functional Gardener cluster on Hetzner Cloud. With this you can run a low cost K8s cluster and run what you want on it. Whereas 23KE is already very cool.</p>
<p>This setup has allowed us to drastically reduce the cost of a fully functional Gardener. As a pleasant side effect, we are no longer dependent on a cloud in the US, but now run Gardener in a data center in Germany with a German operator that is GDPR compliant and uses green electricity (good for our CO<sub>2</sub> footprint).</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/gardener">gardener</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/caph">caph</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/k-8-s">k8s</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/yakecloud/yake/tree/main/docs/blog/2023-05-12-build-cluster-with-caph.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/Gardener Hackathon 2023"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Gardener Hackathon - May 2023</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/hack-the-garden"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Hack-The-Garden - the Remote Hackathon Experience</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tldr" class="table-of-contents__link toc-highlight">TLDR;</a></li><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#setup-the-management-cluster" class="table-of-contents__link toc-highlight">Setup the management cluster</a><ul><li><a href="#modifications" class="table-of-contents__link toc-highlight">Modifications</a></li></ul></li><li><a href="#setup-the-worker-cluster" class="table-of-contents__link toc-highlight">Setup the worker cluster</a></li><li><a href="#install-of-23ke" class="table-of-contents__link toc-highlight">Install of 23KE</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/overview">Docs</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/yakecloud" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/gardener-community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gardener Community<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://gardener-cloud.slack.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/legals">Legals</a></li><li class="footer__item"><a class="footer__link-item" href="/privacy-policy">Privacy policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 23 Technologies GmbH</div></div></div></footer></div>
</body>
</html>