<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.2">
<title data-rh="true">A Gardener Extension for universal Shoot Configuration | Yet another Kubernetes Engine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yake.cloud/blog/gardener-ext-shoot-flux"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="gardener" content="installation, production, operations, maintenance"><meta data-rh="true" property="og:title" content="A Gardener Extension for universal Shoot Configuration | Yet another Kubernetes Engine"><meta data-rh="true" name="description" content="TLDR;"><meta data-rh="true" property="og:description" content="TLDR;"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-06-08T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/jensac"><meta data-rh="true" property="article:tag" content="gardener,gardener-extensions"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yake.cloud/blog/gardener-ext-shoot-flux"><link data-rh="true" rel="alternate" href="https://yake.cloud/blog/gardener-ext-shoot-flux" hreflang="en"><link data-rh="true" rel="alternate" href="https://yake.cloud/blog/gardener-ext-shoot-flux" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://yake.cloud/blog/gardener-ext-shoot-flux","mainEntityOfPage":"https://yake.cloud/blog/gardener-ext-shoot-flux","url":"https://yake.cloud/blog/gardener-ext-shoot-flux","headline":"A Gardener Extension for universal Shoot Configuration","name":"A Gardener Extension for universal Shoot Configuration","description":"TLDR;","datePublished":"2022-06-08T00:00:00.000Z","author":{"@type":"Person","name":"Jens Schneider","description":"software engineer","url":"https://github.com/jensac","image":"https://github.com/jensac.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://yake.cloud/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Yet another Kubernetes Engine RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Yet another Kubernetes Engine Atom Feed"><link rel="stylesheet" href="/assets/css/styles.aea4da5a.css">
<script src="/assets/js/runtime~main.be7c8473.js" defer="defer"></script>
<script src="/assets/js/main.e47c49b3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="YAKE" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo_dark.svg" alt="YAKE" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">YAKE</b></a><a class="navbar__item navbar__link" href="/docs/overview">Docs</a><a class="navbar__item navbar__link" href="/release-notes/v1.108">Release Notes</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/overview">1.108.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/overview">Next</a></li><li><a class="dropdown__link" href="/docs/overview">1.108.x</a></li><li><a class="dropdown__link" href="/docs/1.107.x/overview">1.107.x</a></li><li><a class="dropdown__link" href="/docs/1.106.x/overview">1.106.x</a></li><li><a class="dropdown__link" href="/docs/1.105.x/overview">1.105.x</a></li><li><a class="dropdown__link" href="/docs/1.104.x/overview">1.104.x</a></li><li><a class="dropdown__link" href="/docs/1.103.x/overview">1.103.x</a></li><li><a class="dropdown__link" href="/docs/1.102.x/overview">1.102.x</a></li><li><a class="dropdown__link" href="/docs/1.101.x/overview">1.101.x</a></li><li><a class="dropdown__link" href="/docs/1.100.x/overview">1.100.x</a></li><li><a class="dropdown__link" href="/docs/1.99.x/overview">1.99.x</a></li><li><a class="dropdown__link" href="/docs/1.98.x/overview">1.98.x</a></li><li><a class="dropdown__link" href="/docs/1.97.x/overview">1.97.x</a></li><li><a class="dropdown__link" href="/docs/1.96.x/overview">1.96.x</a></li><li><a class="dropdown__link" href="/docs/1.95.x/overview">1.95.x</a></li><li><a class="dropdown__link" href="/docs/1.94.x/overview">1.94.x</a></li><li><a class="dropdown__link" href="/docs/1.93.x/overview">1.93.x</a></li><li><a class="dropdown__link" href="/docs/1.92.x/overview">1.92.x</a></li><li><a class="dropdown__link" href="/docs/1.91.x/overview">1.91.x</a></li><li><a class="dropdown__link" href="/docs/1.90.x/overview">1.90.x</a></li><li><a class="dropdown__link" href="/docs/1.89.x/overview">1.89.x</a></li><li><a class="dropdown__link" href="/docs/1.88.x/overview">1.88.x</a></li><li><a class="dropdown__link" href="/docs/1.87.x/overview">1.87.x</a></li><li><a class="dropdown__link" href="/docs/1.86.x/overview">1.86.x</a></li><li><a class="dropdown__link" href="/docs/1.85.x/overview">1.85.x</a></li><li><a class="dropdown__link" href="/docs/1.84.x/overview">1.84.x</a></li><li><a class="dropdown__link" href="/docs/1.83.x/overview">1.83.x</a></li><li><a class="dropdown__link" href="/docs/1.82.x/overview">1.82.x</a></li><li><a class="dropdown__link" href="/docs/1.81.x/overview">1.81.x</a></li><li><a class="dropdown__link" href="/docs/1.80.x/overview">1.80.x</a></li><li><a class="dropdown__link" href="/docs/1.79.x/overview">1.79.x</a></li><li><a class="dropdown__link" href="/docs/1.78.x/overview">1.78.x</a></li><li><a class="dropdown__link" href="/docs/1.77.x/overview">1.77.x</a></li><li><a class="dropdown__link" href="/docs/1.76.x/overview">1.76.x</a></li><li><a class="dropdown__link" href="/docs/1.75.x/overview">1.75.x</a></li><li><a class="dropdown__link" href="/docs/1.74.x/overview">1.74.x</a></li><li><a class="dropdown__link" href="/docs/1.73.x/overview">1.73.x</a></li><li><a class="dropdown__link" href="/docs/1.72.x/overview">1.72.x</a></li><li><a class="dropdown__link" href="/docs/1.71.x/overview">1.71.x</a></li><li><a class="dropdown__link" href="/docs/1.70.x/overview">1.70.x</a></li><li><a class="dropdown__link" href="/docs/1.69.x/overview">1.69.x</a></li><li><a class="dropdown__link" href="/docs/1.68.x/overview">1.68.x</a></li><li><a class="dropdown__link" href="/docs/1.67.x/overview">1.67.x</a></li><li><a class="dropdown__link" href="/docs/1.66.x/overview">1.66.x</a></li><li><a class="dropdown__link" href="/docs/1.65.x/overview">1.65.x</a></li><li><a class="dropdown__link" href="/docs/1.64.x/overview">1.64.x</a></li><li><a class="dropdown__link" href="/docs/1.63.x/overview">1.63.x</a></li></ul></div><a href="https://github.com/yakecloud/yake" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Gardener Hackathon 2023">Gardener Hackathon - May 2023</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/build-cluster-with-caph">Build Cluster with CAPH - the challanges when installing 23KE</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hack-the-garden">Hack-The-Garden - the Remote Hackathon Experience</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/gardener-chart-releaser">A Single Point of Truth for Gardener Helm Charts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/gardener-ext-dev">Getting started with Gardener extension development</a></li></ul></div></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">A Gardener Extension for universal Shoot Configuration</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-06-08T00:00:00.000Z">June 8, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/jensac" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jensac.png" alt="Jens Schneider"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/jensac" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Jens Schneider</span></a></div><small class="authorTitle_nd0D" title="software engineer">software engineer</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tldr">TLDR;<a href="#tldr" class="hash-link" aria-label="Direct link to TLDR;" title="Direct link to TLDR;">​</a></h2>
<p>Recently, we developed the <a href="https://github.com/23technologies/gardener-extension-shoot-flux" target="_blank" rel="noopener noreferrer">gardener-extension-shoot-flux</a>, which enables preconfiguring <code>Shoot</code> clusters.
If you want to give it a try, go and checkout the repository on Github.
If you want to learn more, keep on reading.</p>
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#tldr">TLDR;</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#example-use-cases">Example use cases</a>
<ul>
<li><a href="#development">Development</a></li>
<li><a href="#cicd">CI/CD</a></li>
</ul>
</li>
<li><a href="#general-concept">General concept</a></li>
<li><a href="#example-usage">Example Usage</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p><a href="https://fluxcd.io/" target="_blank" rel="noopener noreferrer">Flux</a> offers a set of controllers allowing for reconciling a Kubernetes cluster with a declarative state defined in e.g. a Git repository.
Thus it enables GitOps workflows for Kubernetes clusters.
Moreover, it provides a general approach of deploying software components into Kubernetes clusters.
<a href="https://gardener.cloud/" target="_blank" rel="noopener noreferrer">Gardener</a> is a multi cloud managed Kubernetes service allowing end users to create clusters with a few clicks in its dashboard.
However, the user will obtain a vanilla Kubernetes cluster and has to take care for all the components to be deployed into it.
Of course, the deployment can be performed manually by applying Kubernetes manifests to the cluster.
On the other hand, tools like Flux can help to keep track of the deployments and automate the overall process.
Thus, the combination of Gardener and Flux features the potential of creating new Kubernetes clusters in a pre-defined state.
For the end users, this results in the seamless creation of clusters with all components on their wish list installed.
The <a href="https://github.com/23technologies/gardener-extension-shoot-flux" target="_blank" rel="noopener noreferrer">gardener-extension-shoot-flux</a> bridges the gap between Gardener and Flux and allows for reconciliation of <code>Shoot</code> clusters to resources defined in a Git repository.
By concept, the extension operates on a per-project basis so that clusters in different projects can be reconciled to different repositories.</p>
<p>The rest of this post is organized as follows:
First, we will review a few use cases for this extension.
Further, the general concept of the extension is outlined, and finally we provide an example on how to use the extension.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-use-cases">Example use cases<a href="#example-use-cases" class="hash-link" aria-label="Direct link to Example use cases" title="Direct link to Example use cases">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="development">Development<a href="#development" class="hash-link" aria-label="Direct link to Development" title="Direct link to Development">​</a></h3>
<p>Imagine you are developing software which will eventually run on a Kubernetes cluster in the public cloud.
Moreover, you and your colleagues want to be able to perform some end-to-end tests besides running your local test suite.
For these end-to-end test, an environment mimicking the final production environment is required.
Therefore, you might need tools like <a href="https://cert-manager.io/" target="_blank" rel="noopener noreferrer">cert-manager</a> or <a href="https://min.io/" target="_blank" rel="noopener noreferrer">MinIO</a>.
However, you do not want keep several testing clusters in the public cloud available for economic reasons and, in consequence, you need to create new clusters on demand.
In this case, the <a href="https://github.com/23technologies/gardener-extension-shoot-flux" target="_blank" rel="noopener noreferrer">gardener-extension-shoot-flux</a> comes handy, since it allows to configure the cluster asynchronously.
Put simply, you can define the desired state of your cluster in a Git repository, and the new clusters will be reconciled to this state automatically.
Eventually, this will save the effort to configure the clusters each and every time manually.
Of course, you could achieve something similar by hibernation of the development clusters.
However, in that case you are less flexible, since throwing away the cluster in case you lost track of your clusters state comes at the price of reconfiguring the entire cluster.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cicd">CI/CD<a href="#cicd" class="hash-link" aria-label="Direct link to CI/CD" title="Direct link to CI/CD">​</a></h3>
<p>Similar to the development use case above, you might want to run your CI/CD pipeline in Kubernetes clusters coming with a few components already installed.
As your pipeline runs frequently, you want to create clusters on the fly or maybe pre-spawn just a few of them.
In order to keep your pipeline simple, you can use the <a href="https://github.com/23technologies/gardener-extension-shoot-flux" target="_blank" rel="noopener noreferrer">gardener-extension-shoot-flux</a> for the configuration of your CI/CD clusters.
This way your pipeline can focus on the actual action and does not have to perform the cluster configuration beforehand.
This most probably results in cleaner and more stable CI/CD pipelines.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="general-concept">General concept<a href="#general-concept" class="hash-link" aria-label="Direct link to General concept" title="Direct link to General concept">​</a></h2>
<p>The general concept of this extension is visualized in the block diagram below.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                 ┌─────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │ Gardener operator                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ├─────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │ - A human being                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │                                                         ├────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │                                                         │            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │                                                         │            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 └────────┬────────────────────────────────────────────────┘            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          │                           ▲                                 │configures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          │deploys                    │                                 │SSH-key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          │Configmap                  │read SSH-key                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          │                           │                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          ▼                           │                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ┌────────────────────────────────────┴───────────────────┐             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │ Garden cluster                                         │             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ├────────────────────────┬─────────────────────────┬─────┤             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │ Projetct 1             │ Project 2               │ ... │             ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ├────────────────────────┼─────────────────────────┼─────┤  ┌─────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │- Configmap containing  │- Configmap containing   │     │  │ Git repository      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │  flux configuration    │  flux configuration     │     │  ├─────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │                        │                         │     │  │ - Configuration for │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ┌───►│- ControllerRegistration│- ControllerRegistration │ ... │  │   shoot clusters    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │    │                        │                         │     │  └─────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │    │- Shoot with extension  │- Shoot with extension   │     │             ▲</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │    │  enabled               │  enabled                │     │             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │    │                        │                         │     │             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read config │    │                        │                         │     │             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">and generate│    └────────────────────────┴─────────────────────────┴─────┘             │reconcile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SSH-keys    │                                                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │    ┌────────────────────────┐     ┌────────────────────────┐              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │    │ Seed cluster           │     │ Shoot cluster          │              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │    ├────────────────────────┤     ├────────────────────────┤              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │    │- Controller watching   │     │                        │              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            └────┼─ extension resource    │     │- Flux controllers  ────┼──────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │     │                  │     │                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │     │deploys           │     │- GitRepository resource│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │     │                  │     │                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │     ▼                  │     │- A main kustomization  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │- Managed resources     │     │                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │  for flux controllers  │     │                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │  and flux config       │     │                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 │                        │     │                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 └────────────────────────┘     └────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As depicted, the Gardener operator needs to deploy a <code>ConfigMap</code> into the Garden cluster.
This <code>ConfigMap</code> holds some configuration parameters for the extension controller.
Moreover, the Gardener operator needs to configure an SSH-key for the Git repository in case of a private repository.
This key can be read from the <code>Secret</code> called <code>flux-source</code> in the Garden cluster which is created by the extension controller.
Of course, the process of adding the SSH-key to the repository depends on the repository host.
E.g. for repositories hosted on Github, the key can simply be added as &quot;Deploy key&quot; in the web-interface.</p>
<p>The extension controller is running in <code>Seed</code> clusters.
Besides generating <code>Secret</code>s containing SSH-keys, it reads the configuration from the Garden cluster and creates <code>Managedresources</code> to be processed by the <a href="https://gardener.cloud/docs/gardener/concepts/resource-manager/#managedresource-controller" target="_blank" rel="noopener noreferrer">Gardener Resource Manager</a>.
These <code>Managedresources</code> entail the resources for the Flux controllers, a <a href="https://fluxcd.io/docs/components/source/gitrepositories/" target="_blank" rel="noopener noreferrer">GitRepository</a> resource matching the configuration, and a main <a href="https://fluxcd.io/docs/components/kustomize/kustomization/" target="_blank" rel="noopener noreferrer">Kustomization</a> resource.
Once the Gardener Resource Manager has deployed these resources to the <code>Shoot</code> cluster, the Flux controllers will reconcile the cluster to the state defined in the Git repository.</p>
<p>You might wonder how the communication between <code>Seed</code> clusters and Garden cluster is established.
This is achieved by making use of the <code>Secret</code> containing the <code>gardenlet-kubeconfig</code> which should be available, when the gardenlet is run inside the <code>Seed</code> cluster.
Most probably, this is not the most elegant solution, but it resulted in a quick first working solution.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-usage">Example Usage<a href="#example-usage" class="hash-link" aria-label="Direct link to Example Usage" title="Direct link to Example Usage">​</a></h2>
<p>Of course, you need to install the extension before you can use it.
You can find <code>ControllerRegistration</code>s on our <a href="https://github.com/23technologies/gardener-extension-shoot-flux/releases" target="_blank" rel="noopener noreferrer">Github release page</a>.
So, you can simply go for</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export KUBECONFIG=KUBECONFIG-FOR-GARDEN-CLUSTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -f https://github.com/23technologies/gardener-extension-shoot-flux/releases/download/v0.1.2/controller-registration.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>in order to install the extension.</p>
<p>For an exemplary use of the extension, we prepared a public repository containing manifest for the installation of <a href="https://github.com/stefanprodan/podinfo" target="_blank" rel="noopener noreferrer">Podinfo</a>.
As a Gardener operator you can apply the following <code>ConfigMap</code> to your Garden cluster</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> YOUR</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">PROJECT</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">fluxVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.29.5 </span><span class="token comment" style="color:#999988;font-style:italic"># optional, if not defined the latest release will be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repositoryUrl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/23technologies/shootflux.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repositoryBranch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repositoryType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> public</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As the repository is public you can create a new <code>Shoot</code> now and enable the extension for this <code>Shoot</code>.
Take the snipped below as an example.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> core.gardener.cloud/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Shoot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> garden</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extensions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shoot</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Gardener will take care for the <code>Shoot</code> creation process.
As soon as you can, you can fetch the <code>kubeconfig.yaml</code> for your new <code>Shoot</code> from e.g. the Gardener dashboard.
Now, you can watch this cluster by</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export KUBECONFIG=KUBECONFIG-FOR-SHOOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k9s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and you should see that a <code>podinfo</code> deployment should come up.
Great! You successfully created a <code>Shoot</code> with the <a href="https://github.com/23technologies/gardener-extension-shoot-flux" target="_blank" rel="noopener noreferrer">gardener-extension-shoot-flux</a>.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/gardener">gardener</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/gardener-extensions">gardener-extensions</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/yakecloud/yake/tree/main/docs/blog/2022-06-08-gardener-ext-shoot-flux.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/gardener-ext-dev"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Getting started with Gardener extension development</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tldr" class="table-of-contents__link toc-highlight">TLDR;</a></li><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#example-use-cases" class="table-of-contents__link toc-highlight">Example use cases</a><ul><li><a href="#development" class="table-of-contents__link toc-highlight">Development</a></li><li><a href="#cicd" class="table-of-contents__link toc-highlight">CI/CD</a></li></ul></li><li><a href="#general-concept" class="table-of-contents__link toc-highlight">General concept</a></li><li><a href="#example-usage" class="table-of-contents__link toc-highlight">Example Usage</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/overview">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/yakecloud" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/gardener-community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gardener Community<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gardener-cloud.slack.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/legals">Legals</a></li><li class="footer__item"><a class="footer__link-item" href="/privacy-policy">Privacy policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 23 Technologies GmbH</div></div></div></footer></div>
</body>
</html>