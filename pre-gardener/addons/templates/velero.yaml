{{- if .Values.backups.enabled }}
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: velero
  namespace: flux-system
spec:
  interval: 1m
  chart:
    spec:
      chart: velero
      version: 2.32.6
      sourceRef:
        kind: HelmRepository
        name: vmware-tanzu-charts
        namespace: flux-system
      interval: 1m
  install:
    remediation:
      retries: 10
  values:
    snapshotsEnabled: false

{{- if eq .Values.backups.provider "azure" }}
    credentials:
      useSecret: false
    configuration:
      extraEnvVars:
        AZURE_STORAGE_ACCOUNT_ACCESS_KEY: {{ .Values.backups.credentials.storageAccountAccessKey }}
        AZURE_CLOUD_NAME: AzureGermanCloud
        AZURE_SECRET_ID: {{ .Values.backups.credentials.clientID | b64dec }}
        AZURE_SECRET_VALUE: {{ .Values.backups.credentials.clientSecret | b64dec }}
        AZURE_SUBSCRIPTION_ID: {{ .Values.backups.credentials.subscriptionID | b64dec }}
        AZURE_TENANT_ID: {{ .Values.backups.credentials.tenantID | b64dec }}
      provider: azure
      backupStorageLocation:
        bucket: {{ .Values.backups.bucketName }}
        config:
          storageAccount: {{ .Values.backups.credentials.storageAccount }}
          resourceGroup: 3f319980-d033-430d-a81d-8b067d77942a
          storageAccountKeyEnvVar: AZURE_STORAGE_ACCOUNT_ACCESS_KEY
    initContainers:
      - name: velero-plugin-for-microsoft-azure
        image: velero/velero-plugin-for-microsoft-azure:v1.6.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins

{{- else if eq .Values.backups.provider "aws" }}
    credentials:
      extraEnvVars:
        AWS_ACCESS_KEY_ID: {{ .Values.backups.credentials.accessKeyID }}
        AWS_SECRET_ACCESS_KEY: {{ .Values.backups.credentials.secretAccessKey }}
    configuration:
      provider: aws
      backupStorageLocation:
        bucket: {{ .Values.backups.bucketName }}
        config:
          region: {{ .Values.backups.region }}
    initContainers:
      - name: velero-plugin-for-aws
        image: velero/velero-plugin-for-aws:v1.6.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins

{{- else if eq .Values.backups.provider "openstack" }}
    credentials:
      extraEnvVars:
        OS_AUTH_URL: {{ .Values.backups.credentials.authURL }}
        OS_PASSWORD: {{ .Values.backups.credentials.password }}
        OS_USERNAME: {{ .Values.backups.credentials.username }}
        OS_PROJECT_NAME: {{ .Values.backups.credentials.tenantName }}
        OS_REGION_NAME: {{ .Values.backups.credentials.region }}
        OS_DOMAIN_NAME: {{ .Values.backups.credentials.domainName }}
    configuration:
      provider: community.openstack.org/openstack
      backupStorageLocation:
        bucket: {{ .Values.backups.bucketName }}
        config:
          region: {{ .Values.backups.region }}
    initContainers:
      - name: velero-plugin-for-openstack
        image: lirt/velero-plugin-for-openstack:v0.4.1
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins
{{- end }}

    schedules:
        full-cluster-hourly:
          labels:
            backup: full-cluster
            schedule: hourly
          schedule: "@every 1h"
          template:
            ttl: "52h0m"
            includedNamespaces:
              - '*'
        full-cluster-daily:
          labels:
            backup: full-cluster
            schedule: daily
          schedule: "@every 24h"
          template:
            ttl: "2160h0m"
            includedNamespaces:
              - '*'
{{- end }}
